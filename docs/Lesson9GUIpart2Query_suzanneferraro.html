<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name ="viewport" content="intitial-scale=1, maximum-scale=1, user-scalable=no"> 
<title>Two Synchronized Views</title>

<style>
    html, 
    body,
     #viewDiv{
        padding:0;
        margin:0;
        Height:100%;
        width:100%
     }
      #optionsDiv{
          Background-color: dimgray;
          color:white;
          padding: 10px;
          width: 350px;
          }
          .esri-popup .esri-popup-header .esri-title {
              font-size: 18px;
              font-weight: bolder;
          }
          esri-popup .esri-popup-body .esri-popup-content{
              font-size: 14px;
          }
</style>

<link rel="stylesheet" href="https://js.arcgis.com/4.21/esri/css/main.css">
<script src="https://js.arcgis.com/4.21/"></script>
             <script>
                 require([
                   "esri/Map",
                   "esri/views/SceneView",
                   "esri/layers/GraphicsLayer",
                   "esri/tasks/QueryTask",
                   "esri/tasks/support/Query"  
                   ], function (
                     Map, SceneView,GraphicsLayer,
                     QueryTask,Query 
                     ) {

                     
                    //url to feature service for the most prominent50 peaks in the us 
                     var peaksUrl= "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/Prominent_Peaks_US/FeatureServer/0";

                     //Define what the pupop will contain fter the query is Excuted
                     var popupTemplate ={// autocasts as new popupTemplate()
                    title: "{MTN_PEAK}, {STATE}",
                    fieldInfos:[{
                        fieldName: "ELEV_ft",
                        label:"Elevation (feet)",
                        format:{
                            places:0,
                            digitSeperator: true
                        }
                    }, {
                        fieldName: "ELEV_m",
                        label: "Elevation (meters)",
                        format: {
                            places:0,
                            digitSeperator: true
                        }
                    },{
                        fieldName: "PROMINENCE_ft",
                        label:"Prominence (feet)",
                        format: {
                            places:0,
                            digitSeperator: true
                        }
                    },{
                        fieldName: "PROMINENCE_m",
                        label:"Prominence (meters)",
                        format: {
                            places:0,
                            digitSeperator: true
                        }
                    },{
                        fieldName: "ISOLATION_mi",
                        label:"Isolation (miles)",
                        format: {
                            places:0,
                            digitSeperator: true
                    }
                    },{
                        fieldName: "ISOLATION_km",
                        label:"Isolation (km)",
                        format: {
                            places:0,
                            digitSeperator: true
                    }
                    }],
                    Content: "<b> Prominence:" +
                        "</b> {PROMINENCE_ft} ft ({PROMINENCE_m} m)" +
                        "<br><b>Prominence Rank::</b> {RANK}"+
                        "<br><b> Elevation:</b>{ELEV_ft} ft ({ ELEV_m}m)"+
                        "<br><b>Isolation:"+
                            "</b> {ISOLATION_mi} mi ({ ISOLATION_km} km" 
                };

                var mtnSymbol = {
                    type:"point-3d", //autocasts as a new pointSymbol3D()
                    symbolLayers: [{
                        type: "object", // autocast as new ObjectSymbol3DLayer()
                        resource:{
                            primitive: "cone"
                        }
                    }]
                };

                //create the graphics used to load the data found in the query 
                var resultsLayer = new GraphicsLayer ();

                /* point QueryTask to the Feature service */
                var qTask = new QueryTask({
                    url: peaksUrl
                });

                /*set the query parameters to always return geometery and all fields .
                Returning geometry allows the display results on the map/view 
                */
               var params= new Query ({
                   returnGeometry:true,
                   outFields:["*"]
               });

               var map = new Map({
                   basemap: "gray",
                   layers:[ resultsLayer] //add graphics layer to the /map
               });

               var view = new SceneView({
                   map:map,
                   container:"viewDiv",
                   center: [-100,38],
                   zoom:4,
                   popup: {
                       dockEnabled: true,
                       dockOptions: {
                           position: "bottom-left",
                           breakpoint: false 
                       } 
                   } 
               });

               // Call doQuery() everytime the user clicks the buttom
               view.when(function() {
                   view.ui.add("optionsDiv", "top-right");
                   document.getElementById("doBtn").addEventListener("click",
                    doQuery);
                });

                var attributeName = document.getElementById("attSelect");
                var expressionSign = document.getElementById( "signSelect");
                var value = document.getElementById("valSelect");

                // Executes every time the button os clicked
                function doQuery() {
                    //clear the results from any previous query
                    resultsLayer.removeAll();
                    /*
                    set the where clause for the query. this can be any valid SQL expression.
                    in this casr the inputs from the three drop down menues are used to build 
                    the query. For exmple, if "Elevation ", "is greater than ", and "10,000 ft "
                    are selected, then the following SQL where clause is built here:
                    
                    parms.where = "Elev_ft > 10000";

                    ELEV_ft  is the field name for Elevation and is assigned to the value of the 
                    select option in the HTML below. Other operators such as AND, OR,Like etc
                    may also be used here.
                    */
                   params.where = attributeName.value + expressionSign.value + value.value;
                   
                   /* executes the query and calls get Results() once the promise (response) is resolved 
                   promiseRejected() is called if the promis is rejected*/
                   qTask.execute(params)
                   .then(getResults)
                   .catch(promiseRejected);
                }

                //Called each time the promis is resolved
                function getResults(response){

                    /* Loop through each of the results and assigns a graphic instance and values for t attributes so they can be visualized*/
                    var peakResults = response.features.map(function(
                        feature){

                            /* Sets the symbol of each resulting feature to a cone with a 
                            fixed color and width. The height is based on the mountain's elevation*/
                            feature.symbol = {
                                type: "point-3d", //autocast as new PointSymbols3D()
                                symbolLayers: [{
                                    type: "object", //autocast as new ObjectSymbol3DLayer()
                                    material: {
                                        color: "coral"
                                    },
                                    resource:{
                                        primitive:"cone"
                                    },
                                    width:100000,
                                    height: feature.attributes.ELEV_m * 100
                                }]
                            };
                            
                            feature.popupTemplate = popupTemplate
                            return feature;
                    });

                    resultsLayer.addMany(peakResults);

                    //update the view based on the spatial distribution of the results
                    view.goTo(peakResults) .then(function(){
                        view.popup.open({
                            features: peakResults,
                            featureMenuOpen: true,
                            updateLocationEnabled:true 
                        });
                    });

                    //print(shows in pupop)the number of results returned to the user 
                    document.getElementById("printResults").innerHTML= peakResults.length +
                    "results found!"
                }

                // Called each time the promise is rejected (when Query can't be completed)
                function promiseRejected(error)  {
                    console.error("promise rejected: ", error.message);
                }
            }
            );
            
</script>
</head>

<body>
    <div id = "viewDiv"></div>
    <div class ="esri-widget" id="optionsDiv">
        <h2> Important Peaks in the U.S.</h2>
        <select class= "esri-Widget"id="attSelect">
            <option value="ELEV_ft">Elevation</option>
            <option value= PROMINENCE_ft selected>Prominence</option>
        </select>
        <select class = "esri-widget" id="signSelect">
            <option value=">"> is greater than</option>
            <option value= "<"> is less than</option>
            <option value="="> is equal to </option>
        </select>
        <select class = "esri-widget" id="valSelect">
            <option value="1000">1,000 ft</option>
            <option value= "5000">5,000 ft</option>
            <option value= "10000">10,000 ft</option> 
            <option value="15000">15,000 ft</option>
            <option value="20000">20,000 ft</option>
 </select>
 <br>
 <br>
 <button class= "esri-widget" id="doBtn">Execute Query</button>
 <br>
 <p><span id="printResults"></span> </p>
    </div>
</body>
</html>